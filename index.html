<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ramadan Quran Tracker</title>
  
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { font-family: 'Plus Jakarta Sans', sans-serif; }
    :root { 
      --primary: #2E2A8C; 
      --accent: #2A2780; 
      --gold: #D4AF37;
      --bg: #f8fafc; 
      --surface: #ffffff;
      --border: #f1f5f9;
    }
    body { background-color: var(--bg); color: #1e293b; }
    
    .glass-nav {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    .card-dashboard {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card-dashboard:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.05);
    }

    .input-field {
      border: 1.5px solid #e2e8f0;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .input-field:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(46, 42, 140, 0.1);
      outline: none;
    }

    .nav-tab {
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tab-active {
      background-color: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(46, 42, 140, 0.25);
    }

    .tab-inactive {
      color: #64748b;
    }

    .tab-inactive:hover {
      background-color: #f1f5f9;
      color: #1e293b;
    }

    .header-gradient {
      background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
    }

    .filter-chip {
      padding: 6px 16px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
    }
    .filter-active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .filter-inactive {
      background-color: white;
      color: #64748b;
    }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Ultra Minimalist Pagination */
    .btn-pagination {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 0.7rem;
      transition: all 0.2s;
      color: #94a3b8;
      background: transparent;
    }
    .btn-pagination:hover:not(:disabled) {
      color: var(--primary);
      background: #f1f5f9;
    }
    .btn-pagination:disabled {
      opacity: 0.2;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: white;
      border-radius: 14px;
    }

    .text-primary-theme { color: var(--primary); }
    .text-gold-theme { color: var(--gold); }
    .progress-bar-theme { background-color: var(--gold); }

    /* Pop-up Styles */
    #welcome-popup { transition: all 0.4s ease-out; }
    .popup-content { transform: scale(0.9); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
    #welcome-popup.active .popup-content { transform: scale(1); }

    /* Al-Quran Reader Styles */
    .quran-page-container {
      max-width: 500px;
      margin: 0 auto;
      background: #fff;
      padding: 6px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .quran-img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 8px;
    }
    .nav-read-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 0.6fr;
      gap: 8px;
    }
    @media (max-width: 640px) {
      .nav-read-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body class="h-full">
  <div id="welcome-popup" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm opacity-0 pointer-events-none">
    <div class="popup-content bg-white w-full max-w-sm rounded-[32px] p-8 text-center shadow-2xl border border-slate-100">
      <div class="w-20 h-20 bg-amber-50 text-gold-theme rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
        <i class="fas fa-moon text-3xl"></i>
      </div>
      <h2 class="text-2xl font-extrabold text-slate-800 mb-2">Selamat Datang Kembali!</h2>
      <p class="text-slate-500 leading-relaxed mb-8">
        "Bacalah Al-Quran, karena ia akan datang pada hari kiamat sebagai syafaat bagi pembacanya." <br>
        <span class="block mt-4 font-bold text-primary-theme italic">Semangat tilawah di bulan yang penuh berkah ini! ✨</span>
      </p>
      <button onclick="closePopup()" class="btn-primary w-full py-4 font-bold text-lg shadow-xl active:scale-95 transition-transform">
        Mulai Mencatat
      </button>
    </div>
  </div>

  <div class="min-h-screen pb-24">
    <header class="header-gradient pt-10 pb-20 px-6 text-center text-white shadow-lg">
      <div class="max-w-4xl mx-auto">
        <div class="inline-flex items-center justify-center p-2 bg-white rounded-2xl mb-4 backdrop-blur-sm shadow-md">
          <img src="https://stiba.ac.id/wp-content/uploads/2025/07/IAI-STIBA-Makassar-Logo-berwarna-teks-indo.png" 
               alt="Logo IAI STIBA Makassar" 
               class="h-16 w-auto object-contain">
        </div>
        <h1 class="text-3xl font-extrabold tracking-tight">Ramadan Quran Hub</h1>
        <p class="text-white/80 mt-2 opacity-90 font-medium text-sm">Monitoring Progres Tilawah Harian</p>
      </div>
    </header>

    <nav class="glass-nav sticky top-4 mx-4 md:mx-auto max-w-2xl mt-[-32px] p-2 rounded-2xl border border-white/50 shadow-xl z-50 overflow-x-auto no-scrollbar">
      <div class="flex items-center justify-between gap-1 min-w-max">
        <div onclick="showSection('dashboard')" id="tab-dashboard" class="nav-tab tab-active">
          <i class="fas fa-chart-pie"></i> Dashboard
        </div>
        <div onclick="showSection('read')" id="tab-read" class="nav-tab tab-inactive">
          <i class="fas fa-book-quran"></i> Baca
        </div>
        <div onclick="showSection('form')" id="tab-form" class="nav-tab tab-inactive">
          <i class="fas fa-plus-circle"></i> Lapor
        </div>
        <div onclick="showSection('leaderboard')" id="tab-leaderboard" class="nav-tab tab-inactive">
          <i class="fas fa-award"></i> Peringkat
        </div>
        <div onclick="showSection('history')" id="tab-history" class="nav-tab tab-inactive">
          <i class="fas fa-history"></i> Riwayat
        </div>
      </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 mt-8">
      
      <section id="section-dashboard" class="space-y-6 animate-in fade-in duration-500">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="card-dashboard p-6 flex flex-col items-center justify-center text-center">
            <span class="p-3 bg-slate-50 text-primary-theme rounded-xl mb-3"><i class="fas fa-file-signature text-xl"></i></span>
            <div id="stat-total" class="text-3xl font-bold text-slate-800">0</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Total Laporan</div>
          </div>
          <div class="card-dashboard p-6 flex flex-col items-center justify-center text-center border-b-4 border-b-gold-theme" style="border-bottom-color: var(--gold);">
            <span class="p-3 bg-amber-50 text-gold-theme rounded-xl mb-3"><i class="fas fa-crown text-xl"></i></span>
            <div id="stat-khatam" class="text-3xl font-bold text-slate-800">0</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Peserta Khatam</div>
          </div>
          <div class="card-dashboard p-6 flex flex-col items-center justify-center text-center">
            <span class="p-3 bg-blue-50 text-primary-theme rounded-xl mb-3"><i class="fas fa-calendar-check text-xl"></i></span>
            <div id="stat-today" class="text-3xl font-bold text-slate-800">0</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Laporan Hari Ini</div>
          </div>
        </div>

        <div class="card-dashboard p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm">
              <i class="fas fa-tasks text-primary-theme"></i> Progres Keseluruhan
            </h3>
            <span id="prog-pct" class="text-xs font-bold text-primary-theme bg-slate-50 px-3 py-1 rounded-full">0%</span>
          </div>
          <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
            <div id="prog-bar" class="h-full progress-bar-theme transition-all duration-1000 ease-out" style="width:0%"></div>
          </div>
        </div>

        <div class="card-dashboard p-6">
          <div class="flex items-center justify-between mb-5 border-b pb-3 border-slate-50">
            <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm">
              <i class="fas fa-bolt text-gold-theme"></i> Laporan Terbaru
            </h3>
            <div id="recent-pagination" class="flex items-center gap-1"></div>
          </div>
          <div id="recent-list" class="space-y-4 text-sm"></div>
        </div>
      </section>

      <section id="section-read" class="hidden animate-in fade-in duration-500 space-y-4">
        <div class="card-dashboard p-5">
          <div class="nav-read-grid mb-6">
             <div>
               <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block ml-1">Surah</label>
               <select id="quran-surah-select" onchange="jumpToSurah()" class="input-field w-full p-2 text-xs font-bold bg-slate-50 border-transparent"></select>
             </div>
             <div>
               <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block ml-1">Juz</label>
               <select id="quran-juz-select" onchange="jumpToJuz()" class="input-field w-full p-2 text-xs font-bold bg-slate-50 border-transparent"></select>
             </div>
             <div>
               <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block ml-1">Hal</label>
               <input type="number" id="quran-page-input" min="1" max="604" value="1" onchange="jumpToPage()" class="input-field w-full p-2 text-xs font-bold text-center bg-slate-50 border-transparent">
             </div>
          </div>

          <div class="quran-page-container border border-slate-50">
             <img id="quran-img" src="https://android.quran.com/data/width_1024/page001.png" class="quran-img shadow-sm" alt="Quran Page">
          </div>

          <div class="flex justify-between items-center mt-6 px-2">
            <button onclick="changeQuranPage(1)" class="p-3 text-slate-400 hover:text-primary-theme transition-colors">
              <i class="fas fa-arrow-left"></i>
            </button>
            <span id="page-label" class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Halaman 1</span>
            <button onclick="changeQuranPage(-1)" class="p-3 text-slate-400 hover:text-primary-theme transition-colors">
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </section>

      <section id="section-form" class="hidden animate-in slide-in-from-bottom-4 duration-500">
        <div class="card-dashboard p-6 max-w-xl mx-auto shadow-2xl">
          <div class="text-center mb-6">
            <h2 class="text-xl font-bold text-slate-800">Input Tilawah</h2>
            <p class="text-slate-400 text-xs mt-1">Lengkapi data bacaan harian Anda</p>
          </div>
          <form id="report-form" class="space-y-4">
            <div class="space-y-1">
              <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Nama Lengkap</label>
              <select id="f-nama" required class="input-field w-full p-3 bg-white text-slate-700 text-sm font-medium cursor-pointer">
                <option value="">Pilih Nama...</option>
              </select>
            </div>
            <div class="space-y-1">
              <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Kelompok</label>
              <input type="text" id="f-klp" readonly class="input-field w-full p-3 bg-slate-50 text-slate-400 text-sm" placeholder="Otomatis terisi">
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Hari Ke-</label>
                <input type="number" id="f-hari" required class="input-field w-full p-3 text-sm" placeholder="Contoh: 1">
              </div>
              <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Tanggal</label>
                <input type="date" id="f-tgl" required class="input-field w-full p-3 text-sm">
              </div>
            </div>
            <div class="space-y-1">
              <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Jumlah Juz</label>
              <input type="number" step="0.5" id="f-juz" required class="input-field w-full p-3 text-sm" placeholder="0.5 atau 1">
            </div>
            <div class="space-y-1">
              <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Catatan</label>
              <textarea id="f-catatan" rows="2" class="input-field w-full p-3 text-sm" placeholder="Opsional..."></textarea>
            </div>
            <button type="submit" id="f-btn" class="btn-primary w-full py-4 font-bold text-base shadow-xl active:scale-95 transition-transform flex items-center justify-center gap-2">
              <i class="fas fa-paper-plane text-sm"></i> Kirim Laporan
            </button>
          </form>
        </div>
      </section>

      <section id="section-leaderboard" class="hidden space-y-4 animate-in fade-in duration-500">
         <div class="card-dashboard p-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
              <div class="flex items-center gap-3">
                <span class="p-2 bg-amber-50 text-gold-theme rounded-xl text-sm"><i class="fas fa-trophy"></i></span>
                <h2 class="text-lg font-bold text-slate-800">Papan Peringkat</h2>
              </div>
              <div class="flex items-center gap-1 bg-slate-100 p-1 rounded-xl w-fit">
                <div onclick="filterRank('all')" id="filter-all" class="filter-chip filter-active px-3 py-1">Semua</div>
                <div onclick="filterRank('Ikhwah')" id="filter-Ikhwah" class="filter-chip filter-inactive px-3 py-1">Ikhwah</div>
                <div onclick="filterRank('Akhwat')" id="filter-Akhwat" class="filter-chip filter-inactive px-3 py-1">Akhwat</div>
              </div>
            </div>
            <div id="lb-list" class="space-y-1"></div>
         </div>
      </section>

      <section id="section-history" class="hidden space-y-4 animate-in fade-in duration-500">
         <div class="card-dashboard p-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 border-b pb-4 border-slate-50">
              <div class="flex items-center gap-3">
                <span class="p-2 bg-slate-50 text-primary-theme rounded-xl text-sm"><i class="fas fa-clipboard-list"></i></span>
                <h2 class="text-lg font-bold text-slate-800">Semua Riwayat</h2>
              </div>
              <div class="flex items-center gap-2">
                <input type="date" id="history-date-filter" onchange="updateUI()" class="input-field p-2 text-[10px] font-bold text-slate-500 bg-slate-50 border-transparent uppercase">
                <button onclick="resetHistoryFilter()" class="text-[9px] font-black text-rose-400 hover:text-rose-600 uppercase tracking-tighter">RESET</button>
              </div>
            </div>
            <div id="history-pagination" class="flex justify-center items-center gap-4 mb-6"></div>
            <div id="hist-list" class="space-y-4"></div>
         </div>
      </section>
    </main>
  </div>

  <footer class="bg-white border-t border-slate-100 py-10 mt-12">
    <div class="max-w-4xl mx-auto px-6 text-center">
      <p class="text-slate-400 text-[11px] font-semibold leading-relaxed">
        Created by <br> <span class="text-primary-theme font-bold">Panitia Amaliah Ramadan IAI STIBA Makassar</span>
      </p>
      <p class="text-slate-300 text-[9px] uppercase tracking-[0.2em] mt-2">© 2026 • 1447 H</p>
    </div>
  </footer>

  <script>
    const WEB_URL = 'https://script.google.com/macros/s/AKfycby_hQWLOUkhMYETzOcFeo_OA4Tg7R7-2LkgYCVVVVC4Zia_qIkycUfD8YHrJ3Iuf17xdg/exec';
    const BASE_IMAGE_URL = 'https://android.quran.com/data/width_1024/page';
    const TOTAL_PAGES = 604;
    
    // Quran Metadata
    const surahs = [
      {id:1, name:"Al-Fatihah", page:1}, {id:2, name:"Al-Baqarah", page:2}, {id:3, name:"Ali 'Imran", page:50}, {id:4, name:"An-Nisa'", page:77}, {id:5, name:"Al-Ma'idah", page:106}, {id:6, name:"Al-An'am", page:128}, {id:7, name:"Al-A'raf", page:151}, {id:8, name:"Al-Anfal", page:177}, {id:9, name:"At-Taubah", page:187}, {id:10, name:"Yunus", page:208}, {id:11, name:"Hud", page:221}, {id:12, name:"Yusuf", page:235}, {id:13, name:"Ar-Ra'd", page:249}, {id:14, name:"Ibrahim", page:255}, {id:15, name:"Al-Hijr", page:262}, {id:16, name:"An-Nahl", page:267}, {id:17, name:"Al-Isra'", page:282}, {id:18, name:"Al-Kahf", page:293}, {id:19, name:"Maryam", page:305}, {id:20, name:"Ta-Ha", page:312}, {id:21, name:"Al-Anbiya'", page:322}, {id:22, name:"Al-Hajj", page:332}, {id:23, name:"Al-Mu'minun", page:342}, {id:24, name:"An-Nur", page:350}, {id:25, name:"Al-Furqan", page:359}, {id:26, name:"Asy-Syu'ara'", page:367}, {id:27, name:"An-Naml", page:377}, {id:28, name:"Al-Qasas", page:385}, {id:29, name:"Al-'Ankabut", page:396}, {id:30, name:"Ar-Rum", page:404}, {id:31, name:"Luqman", page:411}, {id:32, name:"As-Sajdah", page:415}, {id:33, name:"Al-Ahzab", page:418}, {id:34, name:"Saba'", page:428}, {id:35, name:"Fatir", page:434}, {id:36, name:"Ya-Sin", page:440}, {id:37, name:"As-Saffat", page:446}, {id:38, name:"Sad", page:453}, {id:39, name:"Az-Zumar", page:458}, {id:40, name:"Ghafir", page:467}, {id:41, name:"Fussilat", page:477}, {id:42, name:"Asy-Syura", page:483}, {id:43, name:"Az-Zukhruf", page:489}, {id:44, name:"Ad-Dukhan", page:496}, {id:45, name:"Al-Jathiyah", page:499}, {id:46, name:"Al-Ahqaf", page:502}, {id:47, name:"Muhammad", page:507}, {id:48, name:"Al-Fath", page:511}, {id:49, name:"Al-Hujurat", page:515}, {id:50, name:"Qaf", page:518}, {id:51, name:"Adh-Dhariyat", page:520}, {id:52, name:"At-Tur", page:523}, {id:53, name:"An-Najm", page:526}, {id:54, name:"Al-Qamar", page:528}, {id:55, name:"Ar-Rahman", page:531}, {id:56, name:"Al-Waqi'ah", page:534}, {id:57, name:"Al-Hadid", page:537}, {id:58, name:"Al-Mujadilah", page:542}, {id:59, name:"Al-Hasyr", page:545}, {id:60, name:"Al-Mumtahanah", page:549}, {id:61, name:"As-Saff", page:551}, {id:62, name:"Al-Jumu'ah", page:553}, {id:63, name:"Al-Munafiqun", page:554}, {id:64, name:"At-Taghabun", page:556}, {id:65, name:"At-Talaq", page:558}, {id:66, name:"At-Tahrim", page:560}, {id:67, name:"Al-Mulk", page:562}, {id:68, name:"Al-Qalam", page:564}, {id:69, name:"Al-Haqqah", page:566}, {id:70, name:"Al-Ma'arij", page:568}, {id:71, name:"Nuh", page:570}, {id:72, name:"Al-Jinn", page:572}, {id:73, name:"Al-Muzzammil", page:574}, {id:74, name:"Al-Muddaththir", page:575}, {id:75, name:"Al-Qiyamah", page:577}, {id:76, name:"Al-Insan", page:578}, {id:77, name:"Al-Mursalat", page:580}, {id:78, name:"An-Naba'", page:582}, {id:79, name:"An-Nazi'at", page:583}, {id:80, name:"'Abasa", page:585}, {id:81, name:"At-Takwir", page:586}, {id:82, name:"Al-Infitar", page:587}, {id:83, name:"Al-Mutaffifin", page:587}, {id:84, name:"Al-Inshiqaq", page:589}, {id:85, name:"Al-Buruj", page:590}, {id:86, name:"At-Tariq", page:591}, {id:87, name:"Al-A'la", page:591}, {id:88, name:"Al-Ghashiyah", page:592}, {id:89, name:"Al-Fajr", page:593}, {id:90, name:"Al-Balad", page:594}, {id:91, name:"Ash-Shams", page:595}, {id:92, name:"Al-Layl", page:595}, {id:93, name:"Ad-Duha", page:596}, {id:94, name:"Ash-Sharh", page:596}, {id:95, name:"At-Tin", page:597}, {id:96, name:"Al-'Alaq", page:597}, {id:97, name:"Al-Qadr", page:598}, {id:98, name:"Al-Bayyinah", page:598}, {id:99, name:"Az-Zalzalah", page:599}, {id:100, name:"Al-'Adiyat", page:599}, {id:101, name:"Al-Qari'ah", page:600}, {id:102, name:"At-Takathur", page:600}, {id:103, name:"Al-'Asr", page:601}, {id:104, name:"Al-Humazah", page:601}, {id:105, name:"Al-Fil", page:601}, {id:106, name:"Quraysh", page:602}, {id:107, name:"Al-Ma'un", page:602}, {id:108, name:"Al-Kawthar", page:602}, {id:109, name:"Al-Kafirun", page:603}, {id:110, name:"An-Nasr", page:603}, {id:111, name:"Al-Masad", page:603}, {id:112, name:"Al-Ikhlas", page:604}, {id:113, name:"Al-Falaq", page:604}, {id:114, name:"An-Nas", page:604}
    ];
    const juzs = [
      {id:1, page:1}, {id:2, page:22}, {id:3, page:42}, {id:4, page:62}, {id:5, page:82}, {id:6, page:102}, {id:7, page:121}, {id:8, page:142}, {id:9, page:162}, {id:10, page:182}, {id:11, page:201}, {id:12, page:222}, {id:13, page:242}, {id:14, page:262}, {id:15, page:282}, {id:16, page:302}, {id:17, page:322}, {id:18, page:342}, {id:19, page:362}, {id:20, page:382}, {id:21, page:402}, {id:22, page:422}, {id:23, page:442}, {id:24, page:462}, {id:25, page:482}, {id:26, page:502}, {id:27, page:522}, {id:28, page:542}, {id:29, page:562}, {id:30, page:582}
    ];

    let DB = [];
    let currentRankFilter = 'all';
    let recentPage = 1;
    let historyPage = 1;
    let currentQuranPage = 1;
    const itemsPerPage = 10;

    function closePopup() {
      const p = document.getElementById('welcome-popup');
      p.classList.remove('opacity-100', 'active');
      p.classList.add('opacity-0');
      setTimeout(() => { p.classList.add('hidden'); }, 400);
    }

    function showPopup() {
      const p = document.getElementById('welcome-popup');
      p.classList.remove('hidden');
      setTimeout(() => { p.classList.add('opacity-100', 'active', 'pointer-events-auto'); }, 50);
    }

    function populateQuranSelectors() {
      const s = document.getElementById('quran-surah-select');
      surahs.forEach(x => { s.add(new Option(`${x.id}. ${x.name}`, x.page)); });
      const j = document.getElementById('quran-juz-select');
      juzs.forEach(x => { j.add(new Option(`Juz ${x.id}`, x.page)); });
    }

    function updateQuranUI() {
      const pStr = String(currentQuranPage).padStart(3, '0');
      document.getElementById('quran-img').src = `${BASE_IMAGE_URL}${pStr}.png`;
      document.getElementById('quran-page-input').value = currentQuranPage;
      document.getElementById('page-label').textContent = `Halaman ${currentQuranPage}`;
      const curS = [...surahs].reverse().find(x => x.page <= currentQuranPage);
      if(curS) document.getElementById('quran-surah-select').value = curS.page;
      const curJ = [...juzs].reverse().find(x => x.page <= currentQuranPage);
      if(curJ) document.getElementById('quran-juz-select').value = curJ.page;
    }

    function changeQuranPage(d) {
      let n = currentQuranPage + d;
      if (n >= 1 && n <= TOTAL_PAGES) { currentQuranPage = n; updateQuranUI(); }
    }

    function jumpToPage() {
      const v = parseInt(document.getElementById('quran-page-input').value);
      if (v >= 1 && v <= TOTAL_PAGES) { currentQuranPage = v; updateQuranUI(); }
    }

    function jumpToSurah() { currentQuranPage = parseInt(document.getElementById('quran-surah-select').value); updateQuranUI(); }
    function jumpToJuz() { currentQuranPage = parseInt(document.getElementById('quran-juz-select').value); updateQuranUI(); }

    function localISODate() { return new Date().toLocaleDateString('en-CA'); }
    function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    
    function formatDate(s) { 
      if(!s || s==='-') return '-';
      const clean = s.split('T')[0];
      const p = clean.split(/[-/]/); 
      let d = p[0].length === 4 ? new Date(p[0], p[1]-1, p[2]) : new Date(2000 + parseInt(p[2]), p[0]-1, p[1]);
      return d.toLocaleDateString('id-ID', {day:'numeric', month:'short'});
    }

    function showSection(n) {
      ['dashboard', 'read', 'form', 'leaderboard', 'history'].forEach(s => {
        document.getElementById('section-' + s).classList.add('hidden');
        document.getElementById('tab-' + s).classList.replace('tab-active', 'tab-inactive');
      });
      document.getElementById('section-' + n).classList.remove('hidden');
      document.getElementById('tab-' + n).classList.replace('tab-inactive', 'tab-active');
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    async function init() {
      showPopup();
      populateQuranSelectors();
      try {
        document.getElementById('f-tgl').value = localISODate();
        const nJson = await fetch(WEB_URL + '?action=names').then(r => r.json());
        const sel = document.getElementById('f-nama');
        nJson.data.forEach(p => {
          const o = new Option(p.nama, p.nama);
          o.dataset.klp = p.kelompok;
          sel.add(o);
        });
        sel.onchange = (e) => document.getElementById('f-klp').value = e.target.options[e.target.selectedIndex].dataset.klp || '';
        await loadReports();
      } catch (e) { console.error(e); }
    }

    async function loadReports() {
      const rJson = await fetch(WEB_URL + '?action=reports&t=' + Date.now()).then(r => r.json());
      DB = rJson.data || [];
      updateUI();
    }

    function filterRank(v) {
      currentRankFilter = v;
      ['all', 'Ikhwah', 'Akhwat'].forEach(id => {
        const el = document.getElementById('filter-' + id);
        el.classList.toggle('filter-active', id === v);
        el.classList.toggle('filter-inactive', id !== v);
      });
      updateUI();
    }

    function resetHistoryFilter() { document.getElementById('history-date-filter').value = ''; historyPage = 1; updateUI(); }

    function renderPagination(cId, total, cur, setF) {
      const pages = Math.ceil(total / itemsPerPage);
      const container = document.getElementById(cId);
      if (pages <= 1) { container.innerHTML = ''; return; }
      container.innerHTML = `
        <button onclick="${setF}(${cur - 1})" class="btn-pagination" ${cur === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>
        <span class="text-[9px] font-black text-slate-300 uppercase">${cur} / ${pages}</span>
        <button onclick="${setF}(${cur + 1})" class="btn-pagination" ${cur === pages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>
      `;
    }

    function setRecentPage(p) { recentPage = p; updateUI(); }
    function setHistoryPage(p) { historyPage = p; updateUI(); }

    function updateUI() {
      const today = localISODate();
      const lapHariIni = DB.filter(r => r.tanggal.split('T')[0] === today).length;
      const rekap = {};
      DB.forEach(r => { 
        if (!rekap[r.nama_lengkap]) rekap[r.nama_lengkap] = { nama: r.nama_lengkap, kelompok: r.kelompok, total_juz: 0 };
        rekap[r.nama_lengkap].total_juz += (parseFloat(r.jumlah_juz) || 0); 
      });
      document.getElementById('stat-total').textContent = DB.length;
      document.getElementById('stat-today').textContent = lapHariIni;
      document.getElementById('stat-khatam').textContent = Object.values(rekap).filter(v => v.total_juz >= 30).length;
      const tJuz = DB.reduce((s, r) => s + (parseFloat(r.jumlah_juz) || 0), 0);
      const prog = Math.min(100, (tJuz / 30) * 100);
      document.getElementById('prog-pct').textContent = prog.toFixed(1) + '%';
      document.getElementById('prog-bar').style.width = prog + '%';

      const recStart = (recentPage - 1) * itemsPerPage;
      renderPagination('recent-pagination', DB.length, recentPage, 'setRecentPage');
      document.getElementById('recent-list').innerHTML = DB.slice(recStart, recStart + itemsPerPage).map(r => `
        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
          <div class="flex items-center gap-3">
             <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-primary-theme shadow-sm border border-slate-100"><i class="fas ${r.kelompok==='Ikhwah'?'fa-mars text-blue-500':'fa-venus text-pink-500'} text-xs"></i></div>
             <div><div class="font-bold text-slate-800 text-xs">${escapeHtml(r.nama_lengkap)}</div><div class="text-[10px] font-semibold text-slate-400 ">Hari Ke- ${r.hari_ramadan} • ${r.jumlah_juz} Juz</div></div>
          </div>
          <div class="text-[9px] font-bold text-primary-theme bg-slate-100 px-2 py-1 rounded-full">${formatDate(r.tanggal)}</div>
        </div>`).join('') || '<p class="text-center text-slate-300 py-4 text-xs font-bold">KOSONG</p>';

      let parts = Object.values(rekap);
      if (currentRankFilter !== 'all') parts = parts.filter(p => p.kelompok === currentRankFilter);
      const sorted = parts.sort((a,b) => b.total_juz - a.total_juz).slice(0, 10);
      document.getElementById('lb-list').innerHTML = sorted.map((p, i) => `
        <div class="flex items-center justify-between p-3 hover:bg-slate-50 transition-colors rounded-xl ${i < 3 ? 'bg-amber-50/20' : ''}">
          <div class="flex items-center gap-3"><span class="w-4 text-[10px] font-black text-slate-300 text-center">${i+1}</span><div><span class="text-xs font-bold text-slate-700">${escapeHtml(p.nama)}</span><div class="text-[8px] font-black text-slate-300 uppercase">${p.kelompok}</div></div></div>
          <div class="flex items-center gap-2"><span class="text-xs font-black text-primary-theme">${p.total_juz.toFixed(1)}</span><span class="text-[8px] font-black text-slate-300 uppercase">Juz</span></div>
        </div>`).join('') || '<p class="text-center text-slate-300 py-4 text-[10px] font-bold">KOSONG</p>';

      const histF = document.getElementById('history-date-filter').value;
      const fHist = histF ? DB.filter(r => r.tanggal.split('T')[0] === histF) : DB;
      const histS = (historyPage - 1) * itemsPerPage;
      renderPagination('history-pagination', fHist.length, historyPage, 'setHistoryPage');
      document.getElementById('hist-list').innerHTML = fHist.slice(histS, histS + itemsPerPage).map(r => `
        <div class="card-dashboard p-4 border-l-4 ${r.kelompok === 'Ikhwah' ? 'border-l-blue-400' : 'border-l-pink-400'}">
          <div class="flex justify-between items-start mb-1"><div class="font-bold text-slate-800 text-xs">${escapeHtml(r.nama_lengkap)}</div><span class="text-[9px] font-black uppercase text-slate-300">${r.kelompok}</span></div>
          <div class="flex items-center gap-3 text-[10px] font-bold">
            <span class="text-slate-400 ">Hari Ke- ${r.hari_ramadan} • ${formatDate(r.tanggal)}</span>
            <span class="text-primary-theme font-black">${r.jumlah_juz} Juz</span>
          </div>
          ${r.catatan?`<div class="mt-2 text-[10px] italic text-slate-400 bg-slate-50 p-2 rounded-lg">"${escapeHtml(r.catatan)}"</div>`:''}
        </div>`).join('') || '<p class="text-center text-slate-300 py-4 text-xs font-bold uppercase">KOSONG</p>';
    }

    document.getElementById('report-form').onsubmit = async (e) => {
      e.preventDefault();
      const btn = document.getElementById('f-btn');
      btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
      const body = new URLSearchParams({
        action: 'create',
        nama_lengkap: document.getElementById('f-nama').value,
        kelompok: document.getElementById('f-klp').value,
        hari_ramadan: document.getElementById('f-hari').value,
        tanggal: document.getElementById('f-tgl').value,
        jumlah_juz: document.getElementById('f-juz').value,
        catatan: document.getElementById('f-catatan').value
      });
      try { await fetch(WEB_URL, { method: 'POST', body }); location.reload(); }
      catch (e) { alert("Gagal"); btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane"></i>'; }
    };
    init();
  </script>
</body>
</html>
